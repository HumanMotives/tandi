<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Data Grave</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase client
    const sb = supabase.createClient(
      'https://ticxhncusdycqjftohho.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpY3hobmN1c2R5Y3FqZnRvaGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTg1MzksImV4cCI6MjA2ODY5NDUzOX0.z2KXaX0dv0ucLmC2ctL51vumhx3xuLcV-2ZL8UFbcxM'
    );

    // Record a burial to Supabase
    async function recordBurial(name, method, epitaph) {
      const { data, error } = await sb.from('burials').insert([
        { name, method, epitaph, timestamp: new Date().toISOString() }
      ]);
      if (error) console.error('Failed to record burial:', error.message);
      return data;
    }

    // Load recent burials from Supabase
    async function loadBurials() {
      const { data, error } = await sb
        .from('burials')
        .select('name, method, timestamp')
        .order('timestamp', { ascending: false });
      if (error) {
        console.error('Failed to load burials:', error.message);
        return;
      }
      const graveList = document.getElementById('graveList');
      graveList.innerHTML = '';
      data.forEach(b => {
        const emoji = b.method === 'cremate' ? '‚ö±Ô∏è' : 'ü™¶';
        const tr = document.createElement('tr');
        tr.classList.add('fade-in');
        tr.innerHTML = `<td>${emoji} ${b.name}</td><td>${new Date(b.timestamp).toLocaleString()}</td>`;
        graveList.appendChild(tr);
      });
    }

    // On page load, fetch burials
    document.addEventListener('DOMContentLoaded', loadBurials);
  </script>

  <style>
   body {
      background-color: #f5f1e6;
      font-family: monospace;
      font-size: 12pt;
      color: #333;
      max-width: 800px;
      margin: 4rem auto;
      padding: 0 1.5rem;
    }
    .logo-container { text-align: center; margin-bottom: 2rem; }
    .logo-container img { max-width: 100%; height: auto; }
    hr { border: none; border-top: 1px solid #ccc; margin: 2rem 0; }
    .upload-box { border: 1px dashed #aaa; padding: 2rem; text-align: center; background-color: #fffefa; cursor: pointer; margin-bottom: 2rem; }
    .hidden { display: none; }
    .progress-bar { width: 100%; background-color: #e1ddd1; border: 1px solid #ccc; height: 20px; margin-top: 1rem; }
    .progress-fill { height: 100%; width: 0; background-color: #70695d; transition: width 5s linear; }
    .button { display: block; margin: 1.5rem auto 0.5rem auto; padding: 0.6rem 1.2rem; font-size: 1rem; border: none; background-color: #3a3a3a; color: #fff; cursor: pointer; }
    .link { display: block; margin-top: 1rem; text-align: center; color: #555; text-decoration: underline; cursor: pointer; font-size: 0.9rem; }
    .ceremony { margin-top: 2rem; }
    .tombstone {
      margin-top: 2rem;
      padding: 2rem;
      border: 2px solid #555;
      background-color: #f1f1ee;
      text-align: center;
      font-family: monospace;
      font-size: 1.3rem;
      opacity: 0;
      transition: opacity 2s ease-in;
    }
    .tombstone.show { opacity: 1; }
    .options-afterlife { margin-top: 2rem; text-align: center; font-size: 0.95rem; }
    .graveyard { border-top: 1px solid #ccc; margin-top: 3rem; padding-top: 2rem; }
    .graveyard h2 { font-size: 1.5rem; margin-bottom: 1rem; }
    .graveyard table { width: 100%; font-family: monospace; font-size: 0.95rem; border-collapse: collapse; }
    .graveyard th, .graveyard td { text-align: left; padding: 0.3rem 0.5rem; border-bottom: 1px solid #ddd; }
    .fade-in { animation: fadeIn 2s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    input[type="text"], input[type="email"] { margin-top: 1rem; margin-bottom: 1rem; width: 100%; padding: 0.5rem; border: 1px solid #aaa; font-size: 1rem; }
    #sarcasticRemark { font-family: monospace; font-style: normal; font-size: 1.2rem; }
    footer { text-align: center; font-size: 0.9rem; color: #666; margin-top: 4rem; }
  </style>
</head>
<body>

  <div class="logo-container">
    <img src="datagrave_sitelogo_large.png" alt="The Data Grave Logo">
  </div>

  <hr>

  <div style="text-align:center; margin-bottom: 1rem;">
    <label><input type="radio" name="method" value="bury" checked> Bury</label>
    <label style="margin-left:1rem;"><input type="radio" name="method" value="cremate"> Cremate</label>
  </div>

  <div class="upload-box" id="uploadBox" onclick="document.getElementById('fileInput').click()">
    Upload or drag a file here<br>
    <small>(audio files only)</small>
    <input type="file" id="fileInput" class="hidden" accept="audio/*">
  </div>

  <div id="progressContainer" class="hidden">
    <p id="progressMessage">Analyzing file...</p>
    <div class="progress-bar">
      <div class="progress-fill" id="analyzeFill"></div>
    </div>
  </div>

  <div id="readyToBury" class="hidden">
    <table id="fileInfoTable" style="width:100%; border-collapse: collapse; margin-bottom:1rem;">
      <tr>
        <td id="sarcasticRemark" style="font-style: italic; color: #666; padding-bottom:0.5rem;"></td>
      </tr>
      <tr><th style="text-align:left; padding:0.3rem 0;">Filename:</th><td><strong id="fileName"></strong></td></tr>
      <tr><th style="text-align:left; padding:0.3rem 0;">Date of birth:</th><td id="fileDate"></td></tr>
      <tr><th style="text-align:left; padding:0.3rem 0;">File size:</th><td id="fileSize"></td></tr>
      <tr><th style="text-align:left; padding:0.3rem 0;">Detected vibe:</th><td id="fileVibe"></td></tr>
    </table>
    <label for="epitaph">Anything to add to the tombstone?</label><br>
    <input type="text" id="epitaph" maxlength="100" style="width:100%; margin-top:0.5rem; margin-bottom:1rem;">
    <button class="button" id="buryBtn" onclick="confirmOrBuryFile(this)">Bury this File?</button>
    <div id="cancelLink" class="link hidden" onclick="resetAll()">I've changed my mind</div>
  </div>
  </div>

  <div id="burialProgress" class="hidden">
    <p id="burialMessage">Burying loop...</p>
    <div class="progress-bar">
      <div class="progress-fill" id="buryFill"></div>
    </div>
  </div>

  <div id="ceremony" class="ceremony"></div>

  <div id="aftercare" class="options-afterlife hidden">
    <p>Wish to collect the remains?</p>
    <button onclick="playAshes()">Check the remains</button>
    <br><br>
    <audio id="ashesAudio" controls class="hidden"></audio>
    <div class="link" onclick="location.reload()">Bury another loop</div>
  </div>

  <div class="graveyard">
    <h2>Recently Buried</h2>
    <table>
      <thead><tr><th>Filename</th><th>Date of Burial</th></tr></thead>
      <tbody id="graveList"></tbody>
    </table>
  </div>

  <footer>
    <div class="donate-widget" style="margin-bottom:15px; display:none;"></div>
    Concept &amp; Design by Chris van der Linden. Licensed under
    <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>.
  </footer>

  <script>
    // Main App Logic
    const fileInput = document.getElementById('fileInput');
    const uploadBox = document.getElementById('uploadBox');
    const progressContainer = document.getElementById('progressContainer');
    const analyzeFill = document.getElementById('analyzeFill');
    const readyToBury = document.getElementById('readyToBury');
    const fileNameSpan = document.getElementById('fileName');
    const fileDateSpan = document.getElementById('fileDate');
    const sarcasticRemark = document.getElementById('sarcasticRemark');
    const buryBtn = document.getElementById('buryBtn');
    const cancelLink = document.getElementById('cancelLink');
    const burialProgress = document.getElementById('burialProgress');
    const buryFill = document.getElementById('buryFill');
    const ceremony = document.getElementById('ceremony');
    const ashesAudio = document.getElementById('ashesAudio');
    const graveList = document.getElementById('graveList');

    let selectedFile = null;
    let confirmed = false;

    const sarcasticRemarks = [
      "We see why this one didn't make the cut...",
      "Not the prettiest indeed.",
      "Some loops die so others may live.",
      "This one had... potential.",
      "The DAW giveth, and the DAW taketh away."
    ];

    const eulogies = [
      "As Above So Below.",
      "Not every loop is meant to bloom.",
      "Never Stuck In A Loop Again.",
      "Its Better This Way.",
      "Rest well, dear loop.",
      "Fade Out Forever",
      "Sick Drop. Dead."
    ];

    const cremationPhrases = [
      "Performing last rites...",
      "Firing up the data-cremation furnace...",
      "Approaching the Gates of Loop Heaven...",
      "Disintegrating Your Abominable Frequencies...",
      "Gathering audio ashes..."
    ];

    const ashesSamples = ["ashes1.mp3"];

    fileInput.addEventListener('change', (e) => {
      selectedFile = e.target.files[0];
      if (!selectedFile) return;
      // Hide dropzone after file selection
      uploadBox.classList.add('hidden');
      confirmed = false;
      analyzeFill.style.width = '0';
      progressContainer.classList.remove('hidden');
      readyToBury.classList.add('hidden');

      setTimeout(() => { analyzeFill.style.width = '100%'; }, 50);
      setTimeout(() => {
        progressContainer.classList.add('hidden');
        readyToBury.classList.remove('hidden');
        fileNameSpan.textContent = selectedFile.name;
        fileDateSpan.textContent = new Date(selectedFile.lastModified).toLocaleDateString();
        sarcasticRemark.textContent = '"' + sarcasticRemarks[Math.floor(Math.random() * sarcasticRemarks.length)] + '"';
        document.getElementById('epitaph').value = eulogies[Math.floor(Math.random() * eulogies.length)];
      }, 5000);
    });

    function confirmOrBuryFile(btn) {
      if (!confirmed) {
        btn.textContent = 'Are You Sure?';
        btn.style.backgroundColor = '#a33';
        cancelLink.classList.remove('hidden');
        confirmed = true;
      } else {
        readyToBury.classList.add('hidden');
        burialProgress.classList.remove('hidden');
        const phrase = cremationPhrases[Math.floor(Math.random() * cremationPhrases.length)];
        document.getElementById('burialMessage').textContent = phrase;
        buryFill.style.width = '0';
        setTimeout(() => buryFill.style.width = '100%', 50);
        setTimeout(() => {
          burialProgress.classList.add('hidden');
          showCeremony();
        }, 5000);
      }
    }

    function showCeremony() {
      const now = new Date();
      const name = selectedFile.name;
      const displayName = name.length > 40 ? name.substring(0, 37) + '...' : name;
      const birthDate = new Date(selectedFile.lastModified).toLocaleDateString();
      const deathDate = now.toLocaleDateString();
      const epitaph = document.getElementById('epitaph').value.trim() || "Gone, but never exported.";
      const selectedMethod = document.querySelector('input[name="method"]:checked').value;

      // Record in Supabase
      recordBurial(displayName, selectedMethod, epitaph);

      const tombstone = document.createElement('div');
      tombstone.className = 'tombstone';
      tombstone.innerHTML = `
        Here lies<br><strong>${displayName}</strong><br>
        ${birthDate} ‚Äî ${deathDate}<br><br>
        <em>"${epitaph}"</em>
      `;
      ceremony.innerHTML = '';
      ceremony.appendChild(tombstone);
      setTimeout(() => tombstone.classList.add('show'), 50);

      aftercare.classList.remove('hidden');

      const tr = document.createElement('tr');
      tr.classList.add('fade-in');
      const emoji = selectedMethod === 'cremate' ? '‚ö±Ô∏è' : 'ü™¶';
      tr.innerHTML = `<td>${emoji} ${displayName}</td><td>${now.toLocaleString()}</td>`;
      graveList.prepend(tr);
    }

    function resetAll() {
      selectedFile = null;
      confirmed = false;
      fileInput.value = '';
      document.getElementById('uploadBox').classList.remove('hidden');
      progressContainer.classList.add('hidden');
      readyToBury.classList.add('hidden');
      burialProgress.classList.add('hidden');
      ceremony.innerHTML = '';
      aftercare.classList.add('hidden');
    }

    function playAshes() {
      const sample = ashesSamples[Math.floor(Math.random() * ashesSamples.length)];
      ashesAudio.src = sample;
      ashesAudio.classList.remove('hidden');
      ashesAudio.play();
    }
  </script>
</body>
</html>
