<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Drum Metronoom</title>

<style>
  :root {
    --w: min(1000px, 92vw);
    --pad: 5%;
    --red: #ff3b30;
    --blue: #3a6bff;
    --gray: #d9d9d9;
    --text: #111;
  }

  body {
    margin: 0;
    min-height: 100vh;
    display: grid;
    place-items: center;
    background: #fafafa;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: var(--text);
  }

  .app {
    width: var(--w);
    display: grid;
    gap: 22px;
    justify-items: center;
    text-align: center;
    padding: 34px 14px 44px;
  }

  h1 {
    margin: 0;
    font-size: clamp(34px, 4.6vw, 56px);
    font-weight: 900;
    letter-spacing: 0.2px;
  }

  .buttons {
    display: flex;
    gap: 18px;
    justify-content: center;
    flex-wrap: wrap;
  }

  button {
    font-size: clamp(18px, 2.4vw, 26px);
    padding: 14px 28px;
    border-radius: 18px;
    border: 2px solid #111;
    background: white;
    cursor: pointer;
    min-width: 170px;
  }

  button.primary {
    background: #111;
    color: white;
  }

  button:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  .label {
    font-size: clamp(18px, 2.4vw, 28px);
    font-weight: 900;
  }

  .sub {
    font-size: clamp(14px, 1.9vw, 18px);
    opacity: 0.7;
  }

  .sliderWrap {
    width: 100%;
    display: grid;
    gap: 10px;
    justify-items: center;
  }

  input[type="range"]{
    width: 100%;
    height: 24px;
    accent-color: #111;
  }

  .options {
    width: 100%;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    align-items: end;
  }

  .optionCard {
    background: white;
    border: 2px solid #eee;
    border-radius: 18px;
    padding: 14px 14px 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    text-align: left;
  }

  .optionCard h3{
    margin: 0 0 10px 0;
    font-size: clamp(16px, 2vw, 20px);
    font-weight: 900;
  }

  select {
    width: 100%;
    font-size: 18px;
    padding: 12px 12px;
    border-radius: 14px;
    border: 2px solid #ddd;
    background: white;
  }

  .toggleRow {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
  }

  .toggle {
    display: inline-flex;
    gap: 10px;
    align-items: center;
    font-weight: 800;
    font-size: 16px;
    user-select: none;
  }

  .toggle input {
    width: 22px;
    height: 22px;
  }

  .stage {
    width: 100%;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 18px;
    align-items: center;
  }

  .sequencer {
    position: relative;
    width: 100%;
    height: 170px;
    background: white;
    border: 2px solid #eaeaea;
    border-radius: 22px;
    box-shadow: 0 10px 34px rgba(0,0,0,0.06);
    overflow: hidden;
  }

  .line {
    position: absolute;
    left: var(--pad);
    right: var(--pad);
    top: 50%;
    height: 8px;
    transform: translateY(-50%);
    background: #e6e6e6;
    border-radius: 999px;
  }

  .playhead {
    position: absolute;
    top: 22px;
    bottom: 22px;
    width: 6px;
    border-radius: 999px;
    background: #111;
    transform: translateX(-50%);
    left: var(--pad);
    box-shadow: 0 10px 22px rgba(0,0,0,0.18);
  }

  .step {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    border-radius: 999px;
    transition: transform 120ms ease;
  }

  /* Inactive = small grey */
  .step.inactive {
    width: 18px;
    height: 18px;
    background: var(--gray);
    box-shadow: none;
  }

  /* Active = bigger colored */
  .step.active {
    width: 40px;
    height: 40px;
    box-shadow: 0 10px 22px rgba(0,0,0,0.12);
    border: 3px solid white;
  }

  .step.handR { background: var(--red); }
  .step.handL { background: var(--blue); }

  .step.pop {
    animation: pop 170ms ease-out;
  }

  @keyframes pop {
    0%   { transform: translate(-50%, -50%) scale(1); }
    60%  { transform: translate(-50%, -50%) scale(1.35); }
    100% { transform: translate(-50%, -50%) scale(1); }
  }

  .multiplier {
    width: clamp(86px, 10vw, 130px);
    height: 170px;
    border-radius: 22px;
    background: #111;
    color: white;
    display: grid;
    place-items: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.14);
  }

  .multiplier span {
    font-size: clamp(32px, 4vw, 56px);
    font-weight: 950;
    letter-spacing: 1px;
  }

  .handRow {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 12px;
    align-items: center;
    justify-items: center;
    padding-top: 6px;
  }

  .handCell {
    min-height: 72px;
    display: grid;
    gap: 6px;
    justify-items: center;
    align-content: start;
    font-weight: 900;
    font-size: 24px;
  }

  .handCell .handIcon {
    font-size: 34px;
    line-height: 1;
  }

  .handCell.R { color: var(--red); }
  .handCell.L { color: var(--blue); }

  .handCell.muted {
    opacity: 0.0;
    pointer-events: none;
  }

  @media (max-width: 820px) {
    .options { grid-template-columns: 1fr; }
    .handRow { gap: 8px; }
  }
</style>
</head>

<body>
  <div class="app">
    <h1>Drum Metronoom</h1>

    <div class="buttons">
      <button id="playBtn" class="primary">Play</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>

    <div class="label">Tempo: <span id="bpmValue">103</span> BPM</div>

    <div class="sliderWrap">
      <input id="bpmSlider" type="range" min="50" max="200" value="103" />
      <div class="sub">Schuif langzamer of sneller</div>
    </div>

    <div class="options">
      <div class="optionCard">
        <h3>A) Ingebouwde figuren</h3>
        <select id="patternSelect">
          <option value="single8">Single strokes (8) RLRLRLRL</option>
          <option value="doubles8">Doubles (8) RRLLRRLL</option>
          <option value="paradiddle8">Paradiddle (8) RLRR LRLL</option>
          <option value="quarters4">Kwartnoten (4) R L R L</option>
          <option value="offbeats4">Offbeats (4) L op 2&4</option>
        </select>
      </div>

      <div class="optionCard">
        <div class="toggleRow">
          <h3 style="margin:0;">B) Slider: meer/minder hits</h3>
          <label class="toggle">
            <input id="useSliderMode" type="checkbox" />
            Slider mode
          </label>
        </div>

        <div style="height:10px;"></div>

        <div class="label" style="font-size:20px;">Hits: <span id="hitsValue">4</span> / 8</div>
        <input id="hitsSlider" type="range" min="1" max="8" value="4" />
        <div class="sub">Verdeelt hits automatisch over de maat</div>

        <div style="height:10px;"></div>

        <label class="toggle" style="justify-content:flex-start;">
          <input id="showHandsToggle" type="checkbox" checked />
          Handzetting tonen
        </label>
      </div>
    </div>

    <div class="stage">
      <div>
        <div class="sequencer" id="sequencer">
          <div class="line"></div>
          <div class="playhead" id="playhead"></div>
        </div>

        <div class="handRow" id="handRow"></div>
      </div>

      <div class="multiplier">
        <span id="multiplierText">X1</span>
      </div>
    </div>
  </div>

<script>
  // ===== Core =====
  const STEPS = 8; // 8 posities per maat (achtsten)
  let bpm = 103;

  // ===== DOM =====
  const sequencer = document.getElementById("sequencer");
  const playhead = document.getElementById("playhead");
  const playBtn = document.getElementById("playBtn");
  const stopBtn = document.getElementById("stopBtn");

  const bpmSlider = document.getElementById("bpmSlider");
  const bpmValue = document.getElementById("bpmValue");

  const patternSelect = document.getElementById("patternSelect");

  const useSliderMode = document.getElementById("useSliderMode");
  const hitsSlider = document.getElementById("hitsSlider");
  const hitsValue = document.getElementById("hitsValue");

  const showHandsToggle = document.getElementById("showHandsToggle");
  const handRow = document.getElementById("handRow");

  const multiplierText = document.getElementById("multiplierText");

  // ===== Audio (simple metronome only) =====
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function click(accent = false) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "square";
    osc.frequency.value = accent ? 1200 : 800;
    gain.gain.value = accent ? 0.26 : 0.20;

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    const now = audioCtx.currentTime;
    osc.start(now);
    osc.stop(now + 0.045);
  }

  // ===== Patterns =====
  // hits: boolean per step
  // hands: "R"|"L"|null per step (only meaningful on active steps)
  const BUILT_IN = {
    single8: {
      hits: [1,1,1,1,1,1,1,1],
      hands:[ "R","L","R","L","R","L","R","L" ]
    },
    doubles8: {
      hits: [1,1,1,1,1,1,1,1],
      hands:[ "R","R","L","L","R","R","L","L" ]
    },
    paradiddle8: {
      hits: [1,1,1,1,1,1,1,1],
      hands:[ "R","L","R","R","L","R","L","L" ]
    },
    quarters4: {
      // quarter hits at 0,2,4,6
      hits: [1,0,1,0,1,0,1,0],
      hands:[ "R",null,"L",null,"R",null,"L",null ]
    },
    offbeats4: {
      // hits on 2 and 4 (indices 2 and 6 if you count eight steps per bar starting on 1)
      hits: [0,0,1,0,0,0,1,0],
      hands:[ null,null,"L",null,null,null,"L",null ]
    }
  };

  // ===== Euclidean-ish distribution for slider mode =====
  function euclidean(steps, pulses) {
    const pattern = new Array(steps).fill(0);
    for (let i = 0; i < steps; i++) {
      const v = Math.floor((i * pulses) / steps) !== Math.floor(((i - 1) * pulses) / steps);
      pattern[i] = v ? 1 : 0;
    }
    // safety
    const count = pattern.reduce((a,b)=>a+b,0);
    if (count !== pulses) {
      pattern.fill(0);
      for (let k=0;k<pulses;k++) pattern[k]=1;
    }
    return pattern;
  }

  function handsAlternateFromR(hitsArr) {
    const hands = new Array(STEPS).fill(null);
    let next = "R";
    for (let i=0;i<STEPS;i++){
      if (hitsArr[i]) {
        hands[i] = next;
        next = (next === "R") ? "L" : "R";
      }
    }
    return hands;
  }

  // ===== State for current bar config =====
  let currentHits = new Array(STEPS).fill(0);
  let currentHands = new Array(STEPS).fill(null);

  function computeCurrentPattern() {
    if (useSliderMode.checked) {
      const pulses = Number(hitsSlider.value);
      const hits = euclidean(STEPS, pulses);
      const hands = handsAlternateFromR(hits);
      return { hits, hands };
    } else {
      const key = patternSelect.value;
      const p = BUILT_IN[key];
      return { hits: p.hits.slice(), hands: p.hands.slice() };
    }
  }

  // ===== Visual build =====
  let stepEls = [];
  let stepPos = []; // normalized positions 0..1
  const beatPos = [0, 0.25, 0.5, 0.75]; // quarters, normalized

  function buildSequencer() {
    const keep = Array.from(sequencer.querySelectorAll(".line, .playhead"));
    sequencer.innerHTML = "";
    keep.forEach(el => sequencer.appendChild(el));

    stepEls = [];
    stepPos = [];

    const { hits, hands } = computeCurrentPattern();
    currentHits = hits;
    currentHands = hands;

    const width = sequencer.clientWidth;
    const leftPad = width * 0.05;
    const rightPad = width * 0.95;
    const usable = rightPad - leftPad;

    for (let i = 0; i < STEPS; i++) {
      const isActive = hits[i] === 1;
      const hand = hands[i]; // "R"|"L"|null

      const step = document.createElement("div");
      step.classList.add("step");

      if (isActive) {
        step.classList.add("active");
        if (hand === "R") step.classList.add("handR");
        if (hand === "L") step.classList.add("handL");
      } else {
        step.classList.add("inactive");
      }

      const norm = i / STEPS; // 0..(steps-1)/steps
      stepPos.push(norm);

      const x = leftPad + norm * usable;
      step.style.left = `${x}px`;

      sequencer.appendChild(step);
      stepEls.push(step);
    }

    buildHandRow();
    // reset playhead to start
    playhead.style.left = `${leftPad}px`;
  }

  function buildHandRow() {
    handRow.innerHTML = "";
    const show = showHandsToggle.checked;

    for (let i=0;i<STEPS;i++){
      const cell = document.createElement("div");
      cell.classList.add("handCell");

      if (!show) cell.classList.add("muted");

      const isActive = currentHits[i] === 1;
      const h = currentHands[i];

      if (!isActive || !h) {
        // keep spacing consistent
        cell.innerHTML = `<div style="height:24px;"></div><div style="height:34px;"></div>`;
      } else {
        cell.classList.add(h); // colors via .R/.L
        const icon = (h === "R") ? "✋" : "✋";
        // (zelfde emoji, kleur doet het werk)
        cell.innerHTML = `<div>${h}</div><div class="handIcon">${icon}</div>`;
      }

      handRow.appendChild(cell);
    }
  }

  function popStep(i) {
    const el = stepEls[i];
    if (!el) return;
    if (!el.classList.contains("active")) return;

    el.classList.remove("pop");
    void el.offsetWidth;
    el.classList.add("pop");
  }

  // ===== Pass-detection sync (no drift) =====
  function crossed(prev, curr, target) {
    if (prev === null) return false;
    if (curr >= prev) {
      return target > prev && target <= curr;
    } else {
      // wrap
      return (target > prev && target <= 1) || (target >= 0 && target <= curr);
    }
  }

  // ===== Playback =====
  let isPlaying = false;
  let rafId = null;
  let startPerf = null;
  let prevPos = null;
  let barCount = 0;

  function beatMs(){ return 60000 / bpm; }
  function barMs(){ return beatMs() * 4; }

  function updateMultiplier() {
    multiplierText.textContent = `X${Math.max(1, barCount + 1)}`;
  }

  function setBpm(newBpm) {
    const now = performance.now();
    if (isPlaying && startPerf !== null) {
      const oldBar = barMs();
      const elapsed = now - startPerf;
      const phase = (elapsed % oldBar) / oldBar;

      bpm = newBpm;

      const newBar = barMs();
      startPerf = now - phase * newBar;
    } else {
      bpm = newBpm;
    }
  }

  function frame(t) {
    if (!isPlaying) return;
    if (startPerf === null) startPerf = t;

    const bMs = barMs();
    const elapsed = t - startPerf;
    const pos = (elapsed % bMs) / bMs;

    // move playhead
    const width = sequencer.clientWidth;
    const leftPad = width * 0.05;
    const rightPad = width * 0.95;
    const usable = rightPad - leftPad;
    playhead.style.left = `${leftPad + pos * usable}px`;

    // bar wrap
    if (prevPos !== null && pos < prevPos) {
      barCount += 1;
      updateMultiplier();
    }

    // metronome clicks on quarters
    for (let b = 0; b < beatPos.length; b++) {
      if (crossed(prevPos, pos, beatPos[b])) {
        click(b === 0);
      }
    }

    // pop active steps exactly when passed
    for (let i = 0; i < stepPos.length; i++) {
      if (crossed(prevPos, pos, stepPos[i])) {
        popStep(i);
      }
    }

    prevPos = pos;
    rafId = requestAnimationFrame(frame);
  }

  function play() {
    if (isPlaying) return;
    isPlaying = true;

    audioCtx.resume();

    playBtn.disabled = true;
    stopBtn.disabled = false;

    startPerf = null;
    prevPos = null;
    barCount = 0;
    updateMultiplier();

    rafId = requestAnimationFrame(frame);
  }

  function stop() {
    isPlaying = false;

    playBtn.disabled = false;
    stopBtn.disabled = true;

    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    startPerf = null;
    prevPos = null;
    barCount = 0;
    updateMultiplier();

    // reset playhead
    const width = sequencer.clientWidth;
    const leftPad = width * 0.05;
    playhead.style.left = `${leftPad}px`;
  }

  // ===== UI Wiring =====
  bpmValue.textContent = bpmSlider.value;
  bpm = Number(bpmSlider.value);

  hitsValue.textContent = hitsSlider.value;

  bpmSlider.addEventListener("input", (e) => {
    const val = Number(e.target.value);
    bpmValue.textContent = val;
    setBpm(val);
  });

  playBtn.addEventListener("click", play);
  stopBtn.addEventListener("click", stop);

  patternSelect.addEventListener("change", () => {
    if (!useSliderMode.checked) {
      buildSequencer();
    }
  });

  useSliderMode.addEventListener("change", () => {
    // When slider mode is on, we still keep built-in selector visible,
    // but the slider defines the hits.
    buildSequencer();
  });

  hitsSlider.addEventListener("input", (e) => {
    hitsValue.textContent = e.target.value;
    if (useSliderMode.checked) buildSequencer();
  });

  showHandsToggle.addEventListener("change", () => {
    buildHandRow();
  });

  window.addEventListener("resize", () => buildSequencer());

  // Init
  buildSequencer();
  stop();
</script>
</body>
</html>
