<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Drummer Girl</title>

<style>
  :root{
    --w: min(1200px, 94vw);
    --tan: #e7bc8c;
    --card: #ffffff;
    --ink: #111111;
    --muted: rgba(0,0,0,0.55);
    --line: #e7e7e7;
    --shadow: 0 14px 40px rgba(0,0,0,0.08);

    --red: #ff3b30;
    --blue: #3a6bff;
    --grayDot: #d9d9d9;

    --pad: 5%;
  }

  body{
    margin:0;
    min-height:100vh;
    display:grid;
    place-items:center;
    background:#fafafa;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--ink);
  }

  .app{
    width:var(--w);
    display:grid;
    gap:26px;
    padding:28px 10px 40px;
  }

  /* Top row like mock: logo left, control panel right */
  .top{
    display:grid;
    grid-template-columns: 1fr 1.35fr;
    gap:26px;
    align-items:center;
  }

  .logoBox{
    display:grid;
    place-items:center;
    min-height:220px;
  }

  .logoBox img{
    max-width: 520px;
    width: 100%;
    height:auto;
    object-fit:contain;
  }

  .panel{
    background: var(--tan);
    border-radius: 26px;
    padding: 26px 26px;
    box-shadow: var(--shadow);
    display:grid;
    gap:18px;
  }

  .panelRow{
    display:grid;
    grid-template-columns: 70px 120px 1fr 56px;
    gap:16px;
    align-items:center;
  }

  .icon{
    width:56px;
    height:56px;
    border-radius: 14px;
    background: rgba(255,255,255,0.35);
    display:grid;
    place-items:center;
    font-size:30px;
    user-select:none;
  }

  .labelBox{
    text-align:left;
    font-weight:900;
    color: rgba(255,255,255,0.95);
    line-height:1.05;
  }

  .labelBox .small{
    display:block;
    font-weight:900;
    font-size:16px;
    opacity:0.9;
    margin-bottom:6px;
  }
  .labelBox .value{
    display:block;
    font-size:28px;
    letter-spacing: 0.2px;
  }

  input[type="range"]{
    width:100%;
    height: 22px;
    accent-color: rgba(255,255,255,0.95);
  }

  .muteBtn{
    width:56px;
    height:56px;
    border-radius: 16px;
    border: 0;
    background: rgba(255,255,255,0.35);
    color: rgba(255,255,255,0.95);
    cursor:pointer;
    display:grid;
    place-items:center;
    font-size:24px;
  }

  .muteBtn:active{ transform: scale(0.98); }
  .muteBtn.isMuted{
    background: rgba(0,0,0,0.18);
    color: rgba(255,255,255,0.95);
  }

  .panelActions{
    display:flex;
    gap:14px;
    justify-content:flex-end;
    padding-top:6px;
  }

  .btn{
    border:0;
    cursor:pointer;
    font-weight:900;
    padding: 14px 20px;
    border-radius: 18px;
    font-size:18px;
    min-width: 120px;
    box-shadow: 0 10px 22px rgba(0,0,0,0.10);
  }

  .btn.play{
    background:#111;
    color:#fff;
  }
  .btn.stop{
    background: rgba(255,255,255,0.75);
    color:#111;
  }
  .btn:disabled{
    opacity:0.55;
    cursor:not-allowed;
    box-shadow:none;
  }

  /* Sequencer like earlier, centered and big */
  .stage{
    display:grid;
    grid-template-columns: 1fr;
    gap:14px;
    align-items:center;
  }

  .seqWrap{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:18px;
    align-items:center;
  }

  .sequencer{
    position:relative;
    width:100%;
    height: 180px;
    background: var(--card);
    border: 2px solid #ededed;
    border-radius: 26px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  .line{
    position:absolute;
    left: var(--pad);
    right: var(--pad);
    top: 50%;
    height: 8px;
    transform: translateY(-50%);
    background: #e6e6e6;
    border-radius: 999px;
  }

  .playhead{
    position:absolute;
    top: 24px;
    bottom: 24px;
    width: 6px;
    border-radius: 999px;
    background: #111;
    transform: translateX(-50%);
    left: var(--pad);
    box-shadow: 0 10px 22px rgba(0,0,0,0.18);
  }

  .step{
    position:absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    border-radius: 999px;
  }

  .step.inactive{
    width: 18px;
    height: 18px;
    background: var(--grayDot);
  }

  .step.active{
    width: 44px;
    height: 44px;
    border: 3px solid #fff;
    box-shadow: 0 10px 22px rgba(0,0,0,0.12);
  }

  .step.handR{ background: var(--red); }
  .step.handL{ background: var(--blue); }

  .step.pop{ animation: pop 170ms ease-out; }

  @keyframes pop{
    0%{ transform: translate(-50%, -50%) scale(1); }
    60%{ transform: translate(-50%, -50%) scale(1.35); }
    100%{ transform: translate(-50%, -50%) scale(1); }
  }

  .multiplier{
    width: 140px;
    height: 180px;
    border-radius: 26px;
    background:#111;
    color:#fff;
    display:grid;
    place-items:center;
    box-shadow: var(--shadow);
  }
  .multiplier span{
    font-size: 56px;
    font-weight: 950;
    letter-spacing: 1px;
  }

  /* Hand row (toggleable) */
  .handRow{
    width: 100%;
    display:grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 12px;
    justify-items:center;
    align-items:start;
    padding-top: 6px;
  }

  .handCell{
    min-height: 76px;
    display:grid;
    gap: 6px;
    justify-items:center;
    align-content:start;
    font-weight: 900;
    font-size: 24px;
  }

  .handCell .handIcon{
    font-size: 34px;
    line-height:1;
  }

  .handCell.R{ color: var(--red); }
  .handCell.L{ color: var(--blue); }

  .handCell.hidden{
    opacity:0;
    pointer-events:none;
  }

  .belowControls{
    display:flex;
    gap:14px;
    justify-content:flex-end;
    align-items:center;
  }

  .check{
    display:flex;
    gap:10px;
    align-items:center;
    font-weight: 900;
    color: var(--muted);
    user-select:none;
  }
  .check input{ width:22px; height:22px; }

  @media (max-width: 980px){
    .top{ grid-template-columns: 1fr; }
    .logoBox{ min-height: 160px; }
    .panelRow{ grid-template-columns: 60px 120px 1fr 56px; }
    .multiplier{ width: 120px; }
  }
</style>
</head>

<body>
  <div class="app">

    <div class="top">
      <div class="logoBox">
        <img src="/drummergirl/logo.jpg" alt="Drummer Girl Logo" />
      </div>

      <div class="panel">
        <!-- BPM -->
        <div class="panelRow">
          <div class="icon">üéµ</div>
          <div class="labelBox">
            <span class="small">BPM:</span>
            <span class="value" id="bpmValue">120</span>
          </div>
          <input id="bpmSlider" type="range" min="50" max="200" value="120" />
          <button id="metroMuteBtn" class="muteBtn" title="Mute metronome">üîä</button>
        </div>

        <!-- HITS -->
        <div class="panelRow">
          <div class="icon">ü•Å</div>
          <div class="labelBox">
            <span class="small">HITS:</span>
            <span class="value"><span id="hitsValue">3</span>/<span>8</span></span>
          </div>
          <input id="hitsSlider" type="range" min="1" max="8" value="3" />
          <button id="hitsMuteBtn" class="muteBtn" title="Mute hits">üîä</button>
        </div>

        <!-- (Optional third row placeholder like your mock, kept minimal) -->
        <div class="panelRow" style="opacity:0.85;">
          <div class="icon">üß¢</div>
          <div class="labelBox">
            <span class="small">HANDS:</span>
            <span class="value" style="font-size:22px;">ON/OFF</span>
          </div>
          <input id="handsStrength" type="range" min="0" max="100" value="100" />
          <button id="handsToggleBtn" class="muteBtn" title="Toggle hands row">üëÄ</button>
        </div>

        <div class="panelActions">
          <button id="playBtn" class="btn play">Play</button>
          <button id="stopBtn" class="btn stop" disabled>Stop</button>
        </div>
      </div>
    </div>

    <div class="stage">
      <div class="seqWrap">
        <div>
          <div class="sequencer" id="sequencer">
            <div class="line"></div>
            <div class="playhead" id="playhead"></div>
          </div>

          <div class="belowControls">
            <label class="check">
              <input id="showHands" type="checkbox" checked />
              Show hands
            </label>
          </div>

          <div class="handRow" id="handRow"></div>
        </div>

        <div class="multiplier">
          <span id="barText">X0</span>
        </div>
      </div>
    </div>

  </div>

<script>
  // ===== Constants =====
  const STEPS = 8;                 // 8 positions per bar (like your dots)
  const BEAT_POS = [0, 0.25, 0.5, 0.75]; // quarter notes (1,2,3,4) in bar

  // ===== DOM =====
  const sequencer = document.getElementById("sequencer");
  const playhead  = document.getElementById("playhead");
  const handRow   = document.getElementById("handRow");
  const barText   = document.getElementById("barText");

  const bpmSlider = document.getElementById("bpmSlider");
  const bpmValue  = document.getElementById("bpmValue");

  const hitsSlider = document.getElementById("hitsSlider");
  const hitsValue  = document.getElementById("hitsValue");

  const playBtn = document.getElementById("playBtn");
  const stopBtn = document.getElementById("stopBtn");

  const metroMuteBtn = document.getElementById("metroMuteBtn");
  const hitsMuteBtn  = document.getElementById("hitsMuteBtn");

  const showHands = document.getElementById("showHands");
  const handsToggleBtn = document.getElementById("handsToggleBtn");
  const handsStrength = document.getElementById("handsStrength");

  // ===== Audio =====
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let metronomeMuted = false;
  let hitsMuted = false;

  // Metronome tick: 8th grid audible.
  // - Strong on step 0 (bar start)
  // - Medium on quarter steps (0,2,4,6)
  // - Soft on off-steps (1,3,5,7)
  function metroTick(stepIndex){
    if (metronomeMuted) return;

    const accent = (stepIndex === 0);
    const quarter = (stepIndex % 2 === 0); // 0,2,4,6
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "square";

    // pitch mapping to make it super obvious:
    // accent highest, quarter medium, offbeat lower
    const freq = accent ? 1400 : (quarter ? 950 : 650);
    osc.frequency.value = freq;

    const now = audioCtx.currentTime;
    const peak = accent ? 0.28 : (quarter ? 0.18 : 0.08); // offbeat is intentionally quiet

    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(peak, now + 0.002);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.045);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + 0.055);
  }

  // Hit sound: separate from metronome so you hear the figure
  function hitTick(hand){
    if (hitsMuted) return;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "triangle";
    // subtle hand difference (optional)
    osc.frequency.value = hand === "R" ? 720 : 560;

    const now = audioCtx.currentTime;
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(0.18, now + 0.002);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.03);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + 0.04);
  }

  function updateMuteButton(btn, muted){
    btn.textContent = muted ? "üîá" : "üîä";
    btn.classList.toggle("isMuted", muted);
  }

  // ===== Pattern generation (slider mode only) =====
  function euclidean(steps, pulses) {
    const pattern = new Array(steps).fill(0);
    for (let i = 0; i < steps; i++) {
      const v = Math.floor((i * pulses) / steps) !== Math.floor(((i - 1) * pulses) / steps);
      pattern[i] = v ? 1 : 0;
    }
    // safety
    const count = pattern.reduce((a,b)=>a+b,0);
    if (count !== pulses) {
      pattern.fill(0);
      for (let k=0;k<pulses;k++) pattern[k]=1;
    }
    return pattern;
  }

  function handsAlternateFromR(hitsArr){
    const hands = new Array(STEPS).fill(null);
    let next = "R";
    for (let i=0;i<STEPS;i++){
      if (hitsArr[i]) {
        hands[i] = next;
        next = (next === "R") ? "L" : "R";
      }
    }
    return hands;
  }

  // ===== Visual state =====
  let stepEls = [];
  let stepPos = [];     // normalized 0..1 positions for each step
  let currentHits = new Array(STEPS).fill(0);
  let currentHands = new Array(STEPS).fill(null);

  function buildSequencer(){
    // keep line + playhead
    const keep = Array.from(sequencer.querySelectorAll(".line, .playhead"));
    sequencer.innerHTML = "";
    keep.forEach(el => sequencer.appendChild(el));

    stepEls = [];
    stepPos = [];

    const pulses = Number(hitsSlider.value);
    currentHits = euclidean(STEPS, pulses);
    currentHands = handsAlternateFromR(currentHits);

    const width = sequencer.clientWidth;
    const leftPad = width * 0.05;
    const rightPad = width * 0.95;
    const usable = rightPad - leftPad;

    for (let i=0;i<STEPS;i++){
      const isActive = currentHits[i] === 1;
      const hand = currentHands[i];

      const step = document.createElement("div");
      step.classList.add("step");

      if (isActive){
        step.classList.add("active");
        step.classList.add(hand === "R" ? "handR" : "handL");
      } else {
        step.classList.add("inactive");
      }

      const norm = i / STEPS; // 0..(steps-1)/steps
      stepPos.push(norm);

      const x = leftPad + norm * usable;
      step.style.left = `${x}px`;

      sequencer.appendChild(step);
      stepEls.push(step);
    }

    buildHandRow();
    playhead.style.left = `${leftPad}px`;
  }

  function buildHandRow(){
    handRow.innerHTML = "";
    const show = showHands.checked;

    for (let i=0;i<STEPS;i++){
      const cell = document.createElement("div");
      cell.classList.add("handCell");

      if (!show) cell.classList.add("hidden");

      const isActive = currentHits[i] === 1;
      const h = currentHands[i];

      if (!isActive || !h){
        // keep spacing consistent
        cell.innerHTML = `<div style="height:24px;"></div><div style="height:34px;"></div>`;
      } else {
        cell.classList.add(h);
        cell.innerHTML = `<div>${h}</div><div class="handIcon">‚úã</div>`;
      }

      handRow.appendChild(cell);
    }

    // optional "strength" slider, just fades the row for now
    const strength = Number(handsStrength.value) / 100;
    handRow.style.opacity = show ? String(strength) : "0";
  }

  function popStep(i){
    const el = stepEls[i];
    if (!el) return;
    if (!el.classList.contains("active")) return;

    el.classList.remove("pop");
    void el.offsetWidth;
    el.classList.add("pop");
  }

  // ===== Sync helpers (no drift) =====
  function crossed(prev, curr, target){
    if (prev === null) return false;
    if (curr >= prev){
      return target > prev && target <= curr;
    } else {
      // wrap-around
      return (target > prev && target <= 1) || (target >= 0 && target <= curr);
    }
  }

  // ===== Playback =====
  let bpm = Number(bpmSlider.value);
  let isPlaying = false;
  let rafId = null;
  let startPerf = null;
  let prevPos = null;
  let barCount = 0;

  function beatMs(){ return 60000 / bpm; }
  function barMs(){ return beatMs() * 4; }

  function setBpm(newBpm){
    const now = performance.now();
    if (isPlaying && startPerf !== null){
      const oldBar = barMs();
      const elapsed = now - startPerf;
      const phase = (elapsed % oldBar) / oldBar;

      bpm = newBpm;

      const newBar = barMs();
      startPerf = now - phase * newBar;
    } else {
      bpm = newBpm;
    }
  }

  function updateBarText(){
    barText.textContent = `X${barCount}`;
  }

  function resetPlaybackState(){
    startPerf = null;
    prevPos = null;
    barCount = 0;
    updateBarText();

    const width = sequencer.clientWidth;
    const leftPad = width * 0.05;
    playhead.style.left = `${leftPad}px`;
  }

  function frame(t){
    if (!isPlaying) return;
    if (startPerf === null) startPerf = t;

    const bMs = barMs();
    const elapsed = t - startPerf;
    const pos = (elapsed % bMs) / bMs;

    // move playhead
    const width = sequencer.clientWidth;
    const leftPad = width * 0.05;
    const rightPad = width * 0.95;
    const usable = rightPad - leftPad;
    playhead.style.left = `${leftPad + pos * usable}px`;

    // bar wrap
    if (prevPos !== null && pos < prevPos){
      barCount += 1;
      updateBarText();
    }

    // 8-step metronome (THIS fixes your confusion with 3 hits)
    for (let i=0;i<stepPos.length;i++){
      if (crossed(prevPos, pos, stepPos[i])){
        metroTick(i);

        // hits (figure) on active steps
        if (currentHits[i] === 1){
          popStep(i);
          hitTick(currentHands[i]);
        }
      }
    }

    prevPos = pos;
    rafId = requestAnimationFrame(frame);
  }

  async function play(){
    if (isPlaying) return;
    isPlaying = true;

    await audioCtx.resume();

    playBtn.disabled = true;
    stopBtn.disabled = false;

    resetPlaybackState();
    rafId = requestAnimationFrame(frame);
  }

  function stop(){
    isPlaying = false;

    playBtn.disabled = false;
    stopBtn.disabled = true;

    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;

    // important: stop resets bar counter to zero
    resetPlaybackState();
  }

  // ===== UI wiring =====
  bpmValue.textContent = bpmSlider.value;
  hitsValue.textContent = hitsSlider.value;

  bpmSlider.addEventListener("input", (e)=>{
    const val = Number(e.target.value);
    bpmValue.textContent = String(val);
    setBpm(val);
  });

  hitsSlider.addEventListener("input", (e)=>{
    hitsValue.textContent = e.target.value;
    buildSequencer();
  });

  playBtn.addEventListener("click", play);
  stopBtn.addEventListener("click", stop);

  metroMuteBtn.addEventListener("click", ()=>{
    metronomeMuted = !metronomeMuted;
    updateMuteButton(metroMuteBtn, metronomeMuted);
  });

  hitsMuteBtn.addEventListener("click", ()=>{
    hitsMuted = !hitsMuted;
    updateMuteButton(hitsMuteBtn, hitsMuted);
  });

  showHands.addEventListener("change", buildHandRow);
  handsToggleBtn.addEventListener("click", ()=>{
    showHands.checked = !showHands.checked;
    buildHandRow();
  });
  handsStrength.addEventListener("input", buildHandRow);

  window.addEventListener("resize", buildSequencer);

  // init
  updateMuteButton(metroMuteBtn, metronomeMuted);
  updateMuteButton(hitsMuteBtn, hitsMuted);
  buildSequencer();
  stop();
</script>
</body>
</html>
