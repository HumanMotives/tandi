<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transients &amp; Incantations</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200&display=swap" rel="stylesheet">
  <style>
    body{margin:0;padding:40px;background:#F8FFF4;color:#474350;font-family:'Inter',sans-serif;font-weight:200;text-align:center;}
    img.logo{max-width:200px;margin-bottom:40px;}
    .mode-options{margin-bottom:20px;}
    .mode-options label{font-size:1.1em;margin:0 10px;}
    button{font-size:1em;padding:10px 20px;margin:10px;border:none;border-radius:5px;background:#242524;color:#f7fff4;cursor:pointer;}
    #idea-box{max-width:600px;margin:20px auto;position:relative;}
    #idea {
  background: #F8FFF4;
  border-radius: 8px;
  padding: 1em;
  font-size: 1.2em;
  line-height: 1.6;
  min-height: 3em;

  /* NEW: allow wrapping only at spaces */
  white-space: normal;
  overflow-wrap: break-word;
  word-wrap: break-word;
  hyphens: auto;
}
    #shareBtn,#copyBtn{margin-top:10px;}
    @keyframes fadeInChars{from{opacity:0;transform:translateY(.2em);}to{opacity:1;transform:translateY(0);}}
    .char{display:inline-block;opacity:0;animation:fadeInChars .4s forwards;margin-right:.05em;white-space: pre;color:#474350;}
    footer{margin-top:30px;font-size:.8em;}
  </style>
</head>
<body>
  <!-- Logo -->
  <img src="./ti_logo.png" class="logo" alt="Transients & Incantations logo">

  <!-- Mode -->
  <div class="mode-options">
    <label><input type="radio" name="mode" value="mystical" checked> Mystical</label>
    <label><input type="radio" name="mode" value="normal"> Normal</label>
  </div>

  <!-- Generate -->
  <button id="generateBtn">Generate</button>

  <!-- Result -->
  <div id="idea-box">
    <div id="idea">Loading vocabularyâ€¦</div>
  </div>

  <!-- Actions -->
  <button id="shareBtn">ðŸ“·</button>
  <button id="copyBtn">ðŸ“‹</button>

  <!-- License & Donate -->
  <div style="margin-top:20px;">
    <form action="https://www.paypal.com/donate" method="post" target="_blank">
      <input type="hidden" name="hosted_button_id" value="YOUR_BUTTON_ID_HERE">
      <input type="submit" value="Donate â¤ï¸" style="background:#FECDAA;color:#474350;border:none;padding:10px 20px;border-radius:5px;">
    </form>
  </div>
  <footer>
    Concept & Design by Chris van der Linden. Licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>
  </footer>

  <!-- SCRIPT: load pool.json & init generator -->
  <script>
  let pool;

  // 1) Fetch the JSON from site root
  fetch('/pool.json')
    .then(r => {
      if (!r.ok) throw new Error('pool.json not found');
      return r.json();
    })
    .then(data => {
      pool = data;
      initApp();
    })
    .catch(err => {
      document.getElementById('idea').innerText = 'âš ï¸ ' + err.message;
      console.error(err);
    });

  function initApp() {
    const templates = [
      "As {subject} {verb}, {twist}.",
      "{subject} {verb} {metaphor}, {twist}.",
      "In the patchwork of {metaphor}, {subject} {verb}.",
      "{subject} {verb}â€”{twist}.",
      "{subject} {verb} {metaphor}.",
      "Nothing remains but {subject} that {verb} {metaphor}.",
      "{subject} begins again, {twist}.",
      "{subject} {verb} not in time, but in resonance.",
      "Each pulse {verb} {metaphor}, a memory in delay.",
      "{subject} becomes {twist}."
    ];

    function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
    function genMyst() {
      const t = pick(templates);
      return t
        .replace('{subject}', pick(pool.subjects))
        .replace('{verb}',    pick(pool.verbs))
        .replace('{metaphor}',pick(pool.metaphors))
        .replace('{twist}',   pick(pool.twists));
    }
    function genNorm() {
      return 'Normal mode under revision.';
    }

    function animateText(txt) {
      const box = document.getElementById('idea');
      box.innerHTML = '';
      [...txt].forEach((c,i) => {
        const s = document.createElement('span');
        s.textContent = c;
        s.className = 'char';
        s.style.animationDelay = (i*20)+'ms';
        box.appendChild(s);
      });
    }

    function downloadImage() {
      const txt = document.getElementById('idea').innerText;
      const c = document.createElement('canvas'), W=1080, H=1080;
      c.width=W; c.height=H;
      const ctx = c.getContext('2d');
      ctx.fillStyle='#F8FFF4'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#474350'; ctx.font='36px sans-serif';
      ctx.textAlign='center'; ctx.textBaseline='top';
      const words = txt.split(' '), lines = [], lh=48;
      let line = '';
      words.forEach(w => {
        const test = line + w + ' ';
        if (ctx.measureText(test).width > W*0.8) {
          lines.push(line.trim());
          line = w + ' ';
        } else {
          line = test;
        }
      });
      if (line) lines.push(line.trim());
      let y = (H - lines.length*lh)/2;
      lines.forEach(l => {
        ctx.fillText(l, W/2, y);
        y += lh;
      });
      const logo = new Image();
      logo.src = './ti_logo.png';
      logo.onload = () => {
        ctx.drawImage(logo, W-180, H-180, 120, 120);
        const a = document.createElement('a');
        a.download = 'incantation.png';
        a.href = c.toDataURL();
        a.click();
      };
    }

    // Wire buttons
    document.getElementById('generateBtn').onclick = () => {
      const mode = document.querySelector('input[name="mode"]:checked').value;
      animateText(mode === 'mystical' ? genMyst() : genNorm());
    };
    document.getElementById('shareBtn').onclick = downloadImage;
    document.getElementById('copyBtn').onclick = () => {
      const txt = document.getElementById('idea').innerText;
      navigator.clipboard.writeText(txt).then(() => {
        const b = document.getElementById('copyBtn');
        b.textContent = 'âœ…';
        setTimeout(() => b.textContent = 'ðŸ“‹', 1200);
      });
    };

    // First call
    animateText(genMyst());
  }
  </script>
</body>
</html>
