<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transients &amp; Incantations</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200&display=swap" rel="stylesheet">
  <style>
    body{margin:0;padding:40px 20px;background:#F8FFF4;color:#474350;font-family:'Inter',sans-serif;font-weight:200;text-align:center;}
    img.logo{max-width:180px;margin-bottom:20px;}
    .mode-options{margin-bottom:20px;}
    .mode-options label{font-size:1.1em;margin:0 10px;}
    button{font-size:1em;padding:10px 20px;margin:10px;border:none;border-radius:5px;background:#FECDAA;color:#474350;cursor:pointer;font-family:'Inter',sans-serif;font-weight:200;}
    #idea-box{max-width:600px;margin:20px auto;position:relative;}
    #idea{background:#FAFAC6;border-radius:8px;padding:1em;font-size:1.2em;line-height:1.6;min-height:3em;}
    #shareBtn,#copyBtn{margin-top:10px;}
    @keyframes fadeInChars{from{opacity:0;transform:translateY(0.2em);}to{opacity:1;transform:translateY(0);}}
    .char{display:inline-block;opacity:0;animation:fadeInChars .4s forwards;margin-right:.05em;white-space:pre;color:#474350;}
    footer{margin-top:30px;font-size:.8em;}
  </style>
</head>
<body>
  <img src="./ti_logo.png" class="logo" alt="Transients & Incantations logo">
  <div class="mode-options">
    <label><input type="radio" name="mode" value="mystical" checked> Mystical</label>
    <label><input type="radio" name="mode" value="normal"> Normal</label>
  </div>
  <button id="generateBtn">Generate Idea</button>
  <div id="idea-box">
    <div id="idea">Loadingâ€¦</div>
  </div>
  <button id="shareBtn" title="Download as Image">ðŸ“·</button>
  <button id="copyBtn" title="Copy to Clipboard">ðŸ“‹</button>
  <div style="margin-top:20px;">
    <form action="https://www.paypal.com/donate" method="post" target="_blank">
      <input type="hidden" name="hosted_button_id" value="YOUR_BUTTON_ID_HERE">
      <input type="submit" value="Donate â¤ï¸" style="background:#FECDAA;color:#474350;border:none;padding:10px 20px;border-radius:5px;">
    </form>
  </div>
  <footer>
    Content generated by this tool is licensed under
    <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>.
  </footer>

  <!-- All JavaScript wrapped in one block below -->
  <script>
  let mysticalVocab;

  // 1) Fetch pool.json, then initialize
  fetch('/pool.json')
    .then(r => r.ok ? r.json() : Promise.reject('pool.json not found'))
    .then(data => {
      mysticalVocab = data;
      initGenerator();
    })
    .catch(err => {
      console.error(err);
      document.getElementById('idea').innerText = 'âš ï¸ Error loading vocabulary';
    });

  function initGenerator(){
    // Your templates
    const templates = [
      "As {subject} {verb}, {twist}.",
      "{subject} {verb} {metaphor}, {twist}.",
      "In the patchwork of {metaphor}, {subject} {verb}.",
      "{subject} {verb}â€”{twist}.",
      "{subject} {verb} {metaphor}.",
      "Nothing remains but {subject} that {verb} {metaphor}.",
      "{subject} begins again, {twist}.",
      "{subject} {verb} not in time, but in resonance.",
      "Each pulse {verb} {metaphor}, a memory in delay.",
      "{subject} becomes {twist}."
    ];

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    // Mystical generator
    function generateMystical(){
      const t = pick(templates);
      return t
        .replace('{subject}',  pick(mysticalVocab.subjects))
        .replace('{verb}',     pick(mysticalVocab.verbs))
        .replace('{metaphor}', pick(mysticalVocab.metaphors))
        .replace('{twist}',    pick(mysticalVocab.twists));
    }
    // Placeholder normal
    function generateNormal(){
      return 'Normal mode under revision.';
    }

    // Animated display
    function displayAnimatedText(txt){
      const box = document.getElementById('idea');
      box.innerHTML = '';
      [...txt].forEach((c,i) => {
        const span = document.createElement('span');
        span.textContent = c;
        span.className = 'char';
        span.style.animationDelay = (i*20)+'ms';
        box.appendChild(span);
      });
    }

    // Share as image
    function downloadImageFromIdea(){
      const txt = document.getElementById('idea').innerText;
      const c = document.createElement('canvas'), W=1080, H=1080;
      c.width=W; c.height=H;
      const ctx = c.getContext('2d');
      ctx.fillStyle='#F8FFF4'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#474350';
      ctx.font='36px sans-serif';
      ctx.textAlign='center'; ctx.textBaseline='top';

      // word-wrap
      const words=txt.split(' '), lines=[], lh=48;
      let line='';
      words.forEach(w => {
        const test=line+w+' ';
        if(ctx.measureText(test).width>W*0.8){
          lines.push(line.trim());
          line=w+' ';
        } else {
          line=test;
        }
      });
      if(line) lines.push(line.trim());

      let y=(H-lines.length*lh)/2;
      lines.forEach(l => {
        ctx.fillText(l, W/2, y);
        y += lh;
      });

      // logo watermark
      const logo = new Image();
      logo.src = './ti_logo.png';
      logo.onload = () => {
        ctx.drawImage(logo, W-180, H-180, 120, 120);
        const a = document.createElement('a');
        a.download = 'incantation.png';
        a.href = c.toDataURL();
        a.click();
      };
    }

    // Wire up buttons
    document.getElementById('generateBtn')
      .addEventListener('click', () => {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const idea = (mode==='mystical')? generateMystical() : generateNormal();
        displayAnimatedText(idea);
      });
    document.getElementById('shareBtn')
      .addEventListener('click', downloadImageFromIdea);
    document.getElementById('copyBtn')
      .addEventListener('click', () => {
        const txt = document.getElementById('idea').innerText;
        navigator.clipboard.writeText(txt)
          .then(() => {
            const b = document.getElementById('copyBtn');
            b.textContent='âœ…';
            setTimeout(()=>b.textContent='ðŸ“‹',1200);
          });
      });

    // Generate one on load
    displayAnimatedText(generateMystical());
  }
  </script>
</body>
</html>
