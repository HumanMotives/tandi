<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‚Äî Audio Slice</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 1rem;
      display: flex;
      justify-content: center;
      background: #fef8e8;
      color: #222;
      font-family: sans-serif;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      width: 100%;
      max-width: 500px;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    /* On very narrow screens, stack load button and filename */
    @media (max-width: 400px) {
      .controls-row { flex-direction: column; align-items: stretch; }
    }
    button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
    }
    #filename {
      flex: 1 1 auto;
      font-style: italic;
      text-align: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .controls label {
      display: flex;
      flex-direction: column;
      flex: 1 1 120px;
      font-size: 0.9rem;
    }
    .controls input {
      margin-top: 0.25rem;
      padding: 0.5rem;
      font-size: 1rem;
      width: 100%;
    }
    #log {
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      padding: 0.75rem;
      white-space: pre-wrap;
      font-size: 0.85rem;
      line-height: 1.2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Medieval Drones ‚Äî Audio Slice</h1>

    <div class="controls-row">
      <button id="load">Load Random Audio</button>
      <div id="filename">No audio loaded yet.</div>
    </div>

    <div id="controls" class="controls" style="display:none;">
      <label>
        Start (s)
        <input type="number" id="start" min="0" step="0.1" value="0"/>
      </label>
      <label>
        Length (s)
        <input type="number" id="length" min="0.1" step="0.1" value="1"/>
      </label>
      <button id="play">Play Slice</button>
    </div>

    <div id="log">üìù Log:</div>
  </div>

  <script>
    const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    let buffer = null;

    function log(msg) {
      const L = document.getElementById('log');
      L.textContent += '\n' + msg;
      L.scrollTop = L.scrollHeight;
    }

    async function fetchRandomIdentifier() {
      log('üîç Searching Librivox audio‚Ä¶');
      const q = 'collection:librivoxaudio';
      const res = await fetch(
        'https://archive.org/advancedsearch.php' +
        `?q=${encodeURIComponent(q)}` +
        '&fl[]=identifier' +
        '&rows=50' +
        '&output=json'
      );
      const json = await res.json();
      log('üì• Search response small preview:\n' +
          JSON.stringify(json.response.docs.slice(0,3), null, 2) + '‚Ä¶');
      const docs = json.response?.docs;
      if (!docs?.length) throw new Error('No identifiers found');
      const id = docs[Math.floor(Math.random()*docs.length)].identifier;
      log(`üéØ Picked identifier: ${id}`);
      return id;
    }

    async function pickAudioFile(id) {
      log(`üì• Fetching metadata for ${id}‚Ä¶`);
      const meta = await (await fetch(`https://archive.org/metadata/${id}`)).json();
      const files = meta.files || [];
      const audioFiles = files
        .map(f => f.name)
        .filter(n => /\.(mp3|ogg)$/i.test(n));
      if (!audioFiles.length) throw new Error('No audio files in ' + id);
      const fileName = audioFiles[Math.floor(Math.random()*audioFiles.length)];
      log(`üé∂ Selected file: ${fileName}`);
      return fileName;
    }

    async function loadAudio() {
      document.getElementById('load').disabled = true;
      document.getElementById('load').textContent = 'Loading‚Ä¶';
      try {
        const id = await fetchRandomIdentifier();
        const fileName = await pickAudioFile(id);
        document.getElementById('filename').textContent = `Loaded: ${id}/${fileName}`;

        const url = `https://archive.org/download/${encodeURIComponent(id)}/${encodeURIComponent(fileName)}`;
        log(`‚¨áÔ∏è Downloading ${url}`);
        const data = await (await fetch(url)).arrayBuffer();
        log('üîÑ Decoding audio data‚Ä¶');
        buffer = await audioCtx.decodeAudioData(data);
        log(`‚úÖ Decoded! Duration: ${buffer.duration.toFixed(2)}s`);
        document.getElementById('controls').style.display = 'flex';
      } catch (err) {
        console.error(err);
        log(`‚ùå Error: ${err.message}`);
        document.getElementById('filename').textContent = 'Failed to load audio';
      } finally {
        document.getElementById('load').textContent = 'Load Random Audio';
        document.getElementById('load').disabled = false;
      }
    }

    function playSlice(startSec, durSec) {
      if (!buffer) return alert('Load audio first!');
      log(`‚ñ∂Ô∏è Playing slice: start=${startSec}s, length=${durSec}s`);
      const sr = buffer.sampleRate;
      const startSample = Math.floor(startSec * sr);
      const lenSamples  = Math.floor(durSec  * sr);
      const slice = audioCtx.createBuffer(buffer.numberOfChannels, lenSamples, sr);
      for (let ch=0; ch<buffer.numberOfChannels; ch++){
        buffer.copyFromChannel(slice.getChannelData(ch), ch, startSample);
      }
      const src = audioCtx.createBufferSource();
      src.buffer = slice;
      src.connect(audioCtx.destination);
      src.start();
    }

    document.getElementById('load').onclick = loadAudio;
    document.getElementById('play').onclick = () => {
      const start  = parseFloat(document.getElementById('start').value)  || 0;
      const length = parseFloat(document.getElementById('length').value) || 1;
      playSlice(start, length);
    };
  </script>
</body>
</html>
