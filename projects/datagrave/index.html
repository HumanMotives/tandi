<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Now Data Grave</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Styles (kebab-case, under /styles) -->
  <link rel="stylesheet" href="styles/global.css">
  <link rel="stylesheet" href="styles/burial-flow.css">
  <link rel="stylesheet" href="styles/burial-listings.css">
  <link rel="stylesheet" href="styles/upsell.css">

  <!-- reCAPTCHA & Supabase keys (unchanged) -->
  <script>
    const RECAPTCHA_SITE_KEY = '6LfLF48rAAAAANYVfuKbMf4frZIVuKQ3Y8s5rB5W';
    const SUPABASE_ANON_KEY   = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpY3hobmN1c2R5Y3FqZnRvaGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTg1MzksImV4cCI6MjA2ODY5NDUzOX0.z2KXaX0dv0ucLmC2ctL51vumhx3xuLcV-2ZL8UFbcxM';
   // expose to window so other scripts can read them
  window.RECAPTCHA_SITE_KEY = RECAPTCHA_SITE_KEY;
  window.SUPABASE_ANON_KEY  = SUPABASE_ANON_KEY;
  
  </script>
  <script src="https://www.google.com/recaptcha/api.js?render=6LfLF48rAAAAANYVfuKbMf4frZIVuKQ3Y8s5rB5W" defer></script>


</head>
<body>
  <!-- placeholders for partials -->
  <div id="common-header"></div>

  <div class="page">
  <div class="logo-container">
    <img src="images/datagrave_headphonelogo.png" alt="The Data Grave Logo" class="site-logo">
      <div class="site-title">DATA GRAVE</div>
  </div>

    <div class="dg-hero-stat">
  <span class="tagline">Where musicians bury their unfinished tracks.</span>
  <span class="counts">
    <strong id="dg-buried-count">#0</strong> buried
    <span class="sep">•</span>
    <strong id="dg-cremated-count">#0</strong> cremated
  </span>
</div>


  <hr>

  <div id="burial-zone-placeholder"></div>
  <div id="upsell-section-placeholder"></div>
  <div id="burial-listings-placeholder"></div>
  <div id="common-footer"></div>

  <!-- Common Ninja embed if still needed -->
  <script src="https://cdn.commoninja.com/sdk/latest/commonninja.js" defer></script>

  <!-- dynamic loader for partials + scripts -->
  <script>
    async function loadPartial(containerId, url) {
      const el = document.getElementById(containerId);
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(res.status);
        el.innerHTML = await res.text();
      } catch (err) {
        console.error(`Failed to load ${url}:`, err);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // 1) Header
      await loadPartial('common-header', 'partials/header.html');

      // 2) Burial zone → then its script
      if ((await loadPartial('burial-zone-placeholder', 'partials/burial-zone.html')) !== false) {
        const s = document.createElement('script');
        s.src = 'scripts/burial-flow.js';
        document.body.appendChild(s);
      }

      // 3) Upsell section → then its script
      if ((await loadPartial('upsell-section-placeholder', 'partials/upsell-section.html')) !== false) {
        const s = document.createElement('script');
        s.src = 'scripts/upsells.js';
        document.body.appendChild(s);
      }

      // 4) Burial listings → then its script
      if ((await loadPartial('burial-listings-placeholder', 'partials/burial-listings.html')) !== false) {
        const s = document.createElement('script');
        s.src = 'scripts/burial-listings.js';
        document.body.appendChild(s);
      }

      // 5) Footer
      await loadPartial('common-footer', 'partials/footer.html');

      // 6) Header interactivity (e.g. menu highlighting)
      const sh = document.createElement('script');
      sh.src = 'scripts/header.js';
      document.body.appendChild(sh);
    });
  </script>

<script>
function graveStats(){
  const buriedEl   = document.getElementById('dg-buried-count');
  const crematedEl = document.getElementById('dg-cremated-count');
  if (!buriedEl || !crematedEl) return;

  // Use global if present, else fallback literal
  const URL = window.SUPABASE_URL || 'https://ticxhncusdycqjftohho.supabase.co';
  const KEY = window.SUPABASE_ANON_KEY;
  if (!KEY) { console.error('[grave-stats] SUPABASE_ANON_KEY missing.'); return; }

  async function getCount(methodValue) {
    const u = `${URL}/rest/v1/burials?select=method&method=eq.${encodeURIComponent(methodValue)}`;
    const res = await fetch(u, {
      headers: {
        apikey: KEY,
        Authorization: `Bearer ${KEY}`,
        Prefer: 'count=exact',
        Range: '0-0'
      }
    });
    if (!res.ok) {
      const preview = await res.text().catch(()=> '');
      console.error('[grave-stats] Bad response', res.status, u, preview.slice(0, 160));
      throw new Error(`HTTP ${res.status}`);
    }
    const cr = res.headers.get('content-range');   // "0-0/123"
    return Number(cr?.split('/')?.[1] ?? 0);
  }

  async function refresh() {
    try {
      const [buried, cremated] = await Promise.all([ getCount('bury'), getCount('cremate') ]);
      buriedEl.textContent   = `#${buried}`;
      crematedEl.textContent = `#${cremated}`;
    } catch {
      buriedEl.textContent   = '#—';
      crematedEl.textContent = '#—';
    }
  }

  refresh();
  setInterval(refresh, 30000);
}

// Run after DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', graveStats);
} else {
  graveStats();
}
</script>

  
</body>
</html>
