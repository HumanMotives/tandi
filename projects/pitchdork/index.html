const fetch = require('node-fetch');
const { Configuration, OpenAIApi } = require('openai');

// Initialize OpenAI
const openai = new OpenAIApi(new Configuration({
  apiKey: process.env.OPENAI_API_KEY,
}));

// Helper to get Spotify album/track data
async function fetchSpotify(spotifyUrl) {
  // extract ID from URL
  const id = spotifyUrl.split('/').pop().split('?')[0];
  // get token via Client Credentials
  const tokenRes = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: {
      Authorization: 'Basic ' + Buffer.from(
        `${process.env.SPOTIFY_CLIENT_ID}:${process.env.SPOTIFY_CLIENT_SECRET}`
      ).toString('base64'),
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: 'grant_type=client_credentials'
  });
  const { access_token } = await tokenRes.json();
  // fetch album or track
  const apiType = spotifyUrl.includes('/album/') ? 'albums' : 'tracks';
  const infoRes = await fetch(`https://api.spotify.com/v1/${apiType}/${id}`, {
    headers: { Authorization: 'Bearer ' + access_token }
  });
  return infoRes.json();
}

exports.handler = async (event) => {
  try {
    const { spotifyUrl } = JSON.parse(event.body);
    const info = await fetchSpotify(spotifyUrl);

    // Build prompt
    const title = info.name;
    const artist = (info.artists||[])[0]?.name || '';
    const artUrl = info.images?.[0]?.url || '';
    const prompt = `
Write a snarky, Pitchfork-style music review of the ${info.album_type || info.type} "${title}" by ${artist}. 
Use pretentious, ironic language, then end with "Rating: X.X/10".`;

    // Call OpenAI
    const completion = await openai.createChatCompletion({
      model: 'gpt-3.5-turbo',
      messages: [{ role: 'user', content: prompt }],
      max_tokens: 300,
      temperature: 0.8,
    });

    const text = completion.data.choices[0].message.content.trim();
    // Extract rating from the end
    const match = text.match(/Rating: ([0-9]\.?[0-9]?\/10)$/m);
    const rating = match ? match[1].split('/')[0] : 'â€“';
    const review = text.replace(/Rating: [0-9]\.?[0-9]?\/10$/, '').trim();

    return {
      statusCode: 200,
      body: JSON.stringify({ artUrl, title: `${title} by ${artist}`, review, rating })
    };
  } catch (err) {
    return { statusCode: 500, body: JSON.stringify({ error: err.message }) };
  }
};
