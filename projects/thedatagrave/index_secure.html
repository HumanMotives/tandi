<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Data Grave</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Open Graph -->
  <meta property="og:title" content="Data Grave – Bury Your Unfinished Loops" />
  <meta property="og:description" content="A tongue-in-cheek burial ground for your half-finished music loops." />
  <meta property="og:image" content="https://yourdomain.com/path/to/preview-image.png" />
  <meta property="og:url" content="https://yourdomain.com/" />
  <meta property="og:type" content="website" />
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Data Grave – Bury Your Unfinished Loops" />
  <meta name="twitter:description" content="A tongue-in-cheek burial ground for your half-finished music loops." />
  <meta name="twitter:image" content="https://yourdomain.com/path/to/preview-image.png" />

  <!-- Invisible reCAPTCHA v3 and Supabase anon key -->
  <script>
    const RECAPTCHA_SITE_KEY = '6LfLF48rAAAAANYVfuKbMf4frZIVuKQ3Y8s5rB5W';
    const SUPABASE_ANON_KEY   = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpY3hobmN1c2R5Y3FqZnRvaGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTg1MzksImV4cCI6MjA2ODY5NDUzOX0.z2KXaX0dv0ucLmC2ctL51vumhx3xuLcV-2ZL8UFbcxM';
  </script>
  <script src="https://www.google.com/recaptcha/api.js?render=6LfLF48rAAAAANYVfuKbMf4frZIVuKQ3Y8s5rB5W" async defer></script>

  <style>
    /* … all your existing CSS unchanged … */
    body { background-color: #f5f1e6; font-family: monospace; font-size:12pt; color:#333; max-width:800px; margin:4rem auto; padding:0 1.5rem; }
    /* … etc … */
  </style>
</head>
<body>
  <!-- … all your existing HTML up through the footer … -->
  <div class="logo-container"><img src="datagrave_sitelogo_large.png" alt="The Data Grave Logo"></div>
  <div id="tagline">Where musicians bury their unfinished tracks</div>
  <hr>
  <div id="methodSelector">
    <label><input type="radio" name="method" value="bury" checked> Bury</label>
    <label style="margin-left:1rem;"><input type="radio" name="method" value="cremate"> Cremate</label>
  </div>
  <div class="upload-box" id="uploadBox" onclick="fileInput.click()">
    Upload or drag a file here<br><small>(.wav, .mp3, .ogg only)</small>
    <input type="file" id="fileInput" class="hidden" accept=".wav,.mp3,.ogg">
  </div>
  <div id="progressContainer" class="hidden">
    <p id="progressMessage">Analyzing your creation...</p>
    <div class="progress-bar"><div class="progress-fill" id="analyzeFill"></div></div>
  </div>
  <div id="readyToBury" class="hidden">
    <table style="width:100%; border-collapse:collapse; margin-bottom:1rem;">
      <tr><td id="sarcasticRemark" style="text-align:center; font-style:italic; color:#777;"></td></tr>
      <tr><td colspan="2" style="height:1rem;"></td></tr>
      <tr><th style="text-align:left; padding:0.3rem 0;">Filename:</th><td><strong id="fileName"></strong></td></tr>
      <tr><th style="text-align:left; padding:0.3rem 0;">Date of birth:</th><td id="fileDate"></td></tr>
      <tr><th style="text-align:left; padding:0.3rem 0;">Est. size:</th><td id="fileSize"></td></tr>
      <tr><th style="text-align:left; padding:0.3rem 0;">Detected genre:</th><td id="fileVibe"></td></tr>
    </table>
    <label for="epitaph">Like to add some final farewell words?</label><br>
    <input type="text" id="epitaph" maxlength="100" placeholder="No <, >, http://…"><br>
    <button class="button" id="buryBtn" onclick="confirmOrBuryFile(this)">Commit this File?</button>
    <div id="cancelLink" class="link hidden" onclick="resetAll()">I've changed my mind</div>
  </div>
  <div id="burialProgress" class="hidden">
    <p id="burialMessage">Burying loop...</p>
    <div class="progress-bar"><div class="progress-fill" id="buryFill"></div></div>
  </div>
  <div id="ceremony" class="ceremony"></div>
  <div id="aftercare" class="options-afterlife hidden">
    <p>Wish to collect the remains?</p>
    <button onclick="playAshes()">Check the remains</button><br><br>
    <audio id="ashesAudio" controls class="hidden"></audio>
    <div class="link" onclick="location.reload()">Lay another track to rest</div>
  </div>
  <div class="graveyard">
    <h2>Recent Burials</h2>
    <div class="table-responsive">
      <table>
        <thead><tr><th>Filename</th><th>Date</th><th>Epitaph</th><th>Country</th></tr></thead>
        <tbody id="graveList"></tbody>
      </table>
    </div>
    <div id="paginationControls"></div>
  </div>
  <script src="https://cdn.commoninja.com/sdk/latest/commonninja.js" defer></script>
  <div class="commonninja_component pid-eb2042b9-17f5-46b1-9aef-7990718bdc1c"></div>
  <footer>
    <div class="donate-widget"></div>
    <p>Feedback? Complaints? <a href="https://discord.gg/7teZhkQutJ">Join our Discord</a></p>
    <p>Version 1.5.2</p>
    <p>Concept &amp; Design by Chris van der Linden. Licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>.</p>
  </footer>

  <script>
    // disallow <, >, or any "http" link
    function isClean(str){
      return !/[<>]/.test(str) && !/https?:\/\//i.test(str);
    }

    // RECORD BURIAL (Edge Function) — now includes anon‐key headers
    async function recordBurial(name, method, epitaph){
      if (!isClean(name)||!isClean(epitaph)){ alert("Remove invalid chars."); return; }
      let country="";
      try{ let r=await fetch("https://ipapi.co/country/"); if(r.ok) country=await r.text() }catch{}
      let token=await grecaptcha.execute(RECAPTCHA_SITE_KEY,{action:"record_burial"});
      let res=await fetch(
        "https://ticxhncusdycqjftohho.supabase.co/functions/v1/record-burial", {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
          },
          body:JSON.stringify({name,method,epitaph,country,token})
        }
      );
      if(!res.ok) console.error("Record error:",await res.text());
      return res.json();
    }

    // LOAD BURIALS (Edge Function) — now includes anon‐key headers
    let currentPage=1, pageSize=25;
    async function loadBurials(page=1){
      currentPage=page;
      let res=await fetch(
        "https://ticxhncusdycqjftohho.supabase.co/functions/v1/load-burials", {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`
          },
          body:JSON.stringify({page})
        }
      );
      if(!res.ok){ console.error("Load error:",res.status); return; }
      let {data,totalCount}=await res.json();
      if(!data) return;
      let list=document.getElementById("graveList");
      list.innerHTML="";
      data.forEach(b=>{
        let tr=document.createElement("tr"); tr.classList.add("fade-in");
        let date=new Date(b.timestamp).toLocaleDateString();
        let name=b.name.length>30?b.name.slice(0,27)+"...":b.name;
        let td1=document.createElement("td");
        let img=document.createElement("img");
        img.src=b.method==="cremate"?"icons/icon_urn.png":"icons/icon_tombstone.png";
        img.className="icon-img";
        td1.append(img,document.createTextNode(name));
        let td2=document.createElement("td"); td2.textContent=date;
        let td3=document.createElement("td"); td3.textContent=b.epitaph||"";
        let td4=document.createElement("td"); td4.textContent=b.country||"";
        tr.append(td1,td2,td3,td4);
        list.appendChild(tr);
      });
      renderPaginationControls(totalCount);
    }

    function renderPaginationControls(totalCount){
      let totalPages=Math.ceil(totalCount/pageSize);
      let div=document.getElementById("paginationControls");
      div.innerHTML="";
      for(let i=1;i<=totalPages;i++){
        let btn=document.createElement("button");
        btn.textContent=i; btn.className="page-btn"+(i===currentPage?" active":"");
        btn.onclick=()=>loadBurials(i);
        div.appendChild(btn);
      }
    }

    document.addEventListener("DOMContentLoaded",()=>loadBurials(1));

    // … rest of your upload & ceremony logic unchanged …

    const fileInput      = document.getElementById('fileInput');
    const uploadBox      = document.getElementById('uploadBox');
    const progressContainer = document.getElementById('progressContainer');
    const analyzeFill    = document.getElementById('analyzeFill');
    const readyToBury    = document.getElementById('readyToBury');
    const fileNameSpan   = document.getElementById('fileName');
    const fileDateSpan   = document.getElementById('fileDate');
    const fileSizeTd     = document.getElementById('fileSize');
    const fileVibeTd     = document.getElementById('fileVibe');
    const sarcasticRemark= document.getElementById('sarcasticRemark');
    const buryBtn        = document.getElementById('buryBtn');
    const cancelLink     = document.getElementById('cancelLink');
    const burialProgress = document.getElementById('burialProgress');
    const buryFill       = document.getElementById('buryFill');
    const ceremony       = document.getElementById('ceremony');
    const ashesAudio     = document.getElementById('ashesAudio');
    const graveListEl    = document.getElementById('graveList');
    let selectedFile = null, confirmed = false;

    const sarcasticRemarks = [
      "Right. This one had no potential anyway...",
      "Ever considered gardening instead of composing",
      "We see why this one didn't make the cut...",
      "Not the prettiest indeed.",
      "Some loops die so others may live.",
      "Another auditory tragedy.",
      "This one had... potential.",
      "Good decision. The world has enough crap already.",
      "Even the metronome gave up on this one.",
      "Overcooked. Overcompressed. Jeez",
      "The DAW giveth, and the DAW taketh away."
    ];
    const eulogies = [
      "As Above So Below.", "Not every loop is meant to bloom","A waveform without purpose",
      "Never Stuck In A Loop Again","Its Better This Way","Gone before the drop",
      "Born to be muted.", "128 layers of bad decisions.","Rendered... irrelevant",
      "Rest well, dear loop.", "Fade Out Forever", "Looped once too often", "Sick Drop. Dead."
    ];
    const cremationPhrases = [
      "Performing last rites...", "Praying to the audio gods... hold on ...",
      "Approaching the Gates of Loop Heaven...", "Disintegrating Your Abominable Frequencies...",
      "Processing your terrible creation..."
    ];
    const ashesSamples = ["ashes1.mp3"];
    const vibes = [
      "Chillflop","CringeHop", "Drum & Blahs", "Technope", "Impostor Synth-drome",
      "Synthcrave","Shite","Polka Punk", "Teenage Angst in D Minor","Undefinable",
      "The Sound of Regret", "Grind-NuJazz", "Regretaton", "Nope-step", "EDehhhM",
      "Lo-Fried","Smarmbient"
    ];

    fileInput.addEventListener('change', e => {
      selectedFile = e.target.files[0];
      if (!selectedFile) return;
      uploadBox.classList.add('hidden');
      document.getElementById('methodSelector').style.display = 'none';
      confirmed = false;
      analyzeFill.style.width = '0';
      progressContainer.classList.remove('hidden');
      readyToBury.classList.add('hidden');
      setTimeout(() => analyzeFill.style.width = '100%', 50);
      setTimeout(() => {
        progressContainer.classList.add('hidden');
        readyToBury.classList.remove('hidden');
        sarcasticRemark.textContent = '"' + sarcasticRemarks[Math.floor(Math.random() * sarcasticRemarks.length)] + '"';
        fileNameSpan.textContent = selectedFile.name;
        fileDateSpan.textContent = new Date(selectedFile.lastModified).toLocaleDateString();
        fileSizeTd.textContent = (selectedFile.size / 1024 / 1024).toFixed(2) + ' MB';
        fileVibeTd.textContent = vibes[Math.floor(Math.random() * vibes.length)];
        document.getElementById('epitaph').value = eulogies[Math.floor(Math.random() * eulogies.length)];
      }, 5000);
    });

    function confirmOrBuryFile(btn) {
      if (!confirmed) {
        btn.textContent = 'Are You Sure?';
        btn.style.backgroundColor = '#a33';
        cancelLink.classList.remove('hidden');
        confirmed = true;
      } else {
        readyToBury.classList.add('hidden');
        burialProgress.classList.remove('hidden');
        document.getElementById('burialMessage').textContent = cremationPhrases[Math.floor(Math.random() * cremationPhrases.length)];
        buryFill.style.width = '0';
        setTimeout(() => buryFill.style.width = '100%', 50);
        setTimeout(() => { burialProgress.classList.add('hidden'); showCeremony(); }, 5000);
      }
    }

    function showCeremony() {
      const method = document.querySelector('input[name="method"]:checked').value;
      const epitaphText = document.getElementById('epitaph').value.trim() || "Gone, but never exported.";
      if (!isClean(epitaphText)) { alert("Please remove '<', '>' or links from your epitaph."); resetAll(); return; }
      const displayName = selectedFile.name.length > 30 ? selectedFile.name.substring(0,27) + '...' : selectedFile.name;
      recordBurial(displayName, method, epitaphText);
      ceremony.innerHTML = '';
      const tomb = document.createElement('div'); tomb.className = 'tombstone';
      tomb.innerHTML = `Here lies<br><strong>${displayName}</strong><br>${new Date(selectedFile.lastModified).toLocaleDateString()}<br><br><em>"${epitaphText}"</em>`;
      ceremony.appendChild(tomb);
      setTimeout(() => tomb.classList.add('show'), 50);
      document.getElementById('aftercare').classList.remove('hidden');
      const tr = document.createElement('tr'); tr.classList.add('fade-in');
      const tdName = document.createElement('td');
      const icon = document.createElement('img');
      icon.src = method === 'cremate' ? 'icons/icon_urn.png' : 'icons/icon_tombstone.png';
      icon.className = 'icon-img';
      tdName.append(icon, document.createTextNode(displayName));
      const tdDate2 = document.createElement('td'); tdDate2.textContent = new Date(selectedFile.lastModified).toLocaleDateString();
      const tdEpit2 = document.createElement('td'); tdEpit2.textContent = epitaphText;
      const tdCountry2 = document.createElement('td'); tdCountry2.textContent = '';
      tr.append(tdName, tdDate2, tdEpit2, tdCountry2);
      graveListEl.prepend(tr);
    }

    function resetAll() {
      selectedFile = null;
      confirmed = false;
      fileInput.value = '';
      uploadBox.classList.remove('hidden');
      document.getElementById('methodSelector').style.display = 'block';
      progressContainer.classList.add('hidden');
      readyToBury.classList.add('hidden');
      burialProgress.classList.add('hidden');
      ceremony.innerHTML = '';
      document.getElementById('aftercare').classList.add('hidden');
    }

    function playAshes() {
      ashesAudio.src = ashesSamples[Math.floor(Math.random() * ashesSamples.length)];
      ashesAudio.classList.remove('hidden');
      ashesAudio.play();
    }
  </script>
</body>
</html>
